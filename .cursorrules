# Rules untuk Agent - Telegram MikroTik Backup Bot

## ğŸ“‹ Deskripsi Proyek
Proyek ini adalah Telegram bot untuk backup otomatis perangkat MikroTik melalui SSH. Bot dapat menjalankan backup terjadwal dan manual, mengelola daftar router, dan mengirim file backup ke Telegram.

## ğŸ—ï¸ Struktur Proyek
```
telegram-bot/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ index.js              # Main bot logic, handlers, cron scheduler
â”‚   â”œâ”€â”€ config.js             # Environment configuration loader
â”‚   â””â”€â”€ services/
â”‚       â”œâ”€â”€ mikrotikService.js # SSH operations
â”‚       â””â”€â”€ routerStore.js    # Router CRUD operations
â”œâ”€â”€ data/                      # Runtime data (gitignored)
â”‚   â”œâ”€â”€ routers.json          # Router configurations
â”‚   â””â”€â”€ customSchedule.json   # Custom backup schedule
â”œâ”€â”€ backups/                   # Backup files (gitignored)
â”œâ”€â”€ .env                       # Environment variables (gitignored)
â””â”€â”€ package.json
```

## ğŸ”§ Teknologi & Dependencies
- **Runtime**: Node.js 18+ (CommonJS)
- **Framework**: node-telegram-bot-api (polling mode)
- **SSH**: ssh2 library
- **Scheduler**: node-cron
- **File ops**: fs-extra
- **Date**: date-fns
- **Config**: dotenv

## ğŸ“ Coding Standards

### 1. **Module System**
- âœ… GUNAKAN CommonJS (`require`/`module.exports`)
- âŒ JANGAN gunakan ES6 modules (`import`/`export`)

### 2. **Error Handling**
- âœ… SELALU sanitize error messages yang mungkin mengandung password/kredensial
- âœ… Gunakan fungsi `sanitizeError()` untuk menghapus informasi sensitif
- âœ… Handle network errors (EFATAL, ETIMEDOUT, ECONNRESET) dengan graceful degradation
- âœ… Jangan spam log untuk network errors yang berulang

### 3. **File Operations**
- âœ… Gunakan `fs-extra` untuk operasi file (bukan `fs` native)
- âœ… SELALU gunakan `fs.ensureDir()` sebelum menulis file
- âœ… Untuk `routers.json`, gunakan atomic write (temp file â†’ rename)
- âœ… Gunakan queue-based locking untuk mencegah race conditions

### 4. **SSH Operations**
- âœ… SELALU tutup koneksi SSH dengan `conn.end()` di `finally` block
- âœ… SELALU tutup file streams dengan `stream.destroy()` setelah digunakan
- âœ… Cleanup file remote di MikroTik setelah download (gunakan try-catch agar tidak mempengaruhi backup success)
- âœ… Timeout koneksi: 10 detik (readyTimeout: 10000)

### 5. **Telegram Bot**
- âœ… SELALU check `ensureChatAllowed(chatId)` sebelum memproses pesan
- âœ… Gunakan session management untuk wizard flows (add router, set schedule)
- âœ… Auto-cleanup session setelah 30 menit timeout
- âœ… Handle keyboard button presses dan callback queries
- âœ… Jangan kirim error message jika network down (akan fail lagi)

### 6. **Session Management**
- âœ… Gunakan `sessions` Map untuk tracking wizard flows
- âœ… Gunakan `sessionTimeouts` Map untuk auto-cleanup
- âœ… Clear session setelah selesai atau cancel
- âœ… Set timeout 30 menit untuk setiap session

### 7. **Cron Scheduling**
- âœ… Load custom schedule dari `data/customSchedule.json` saat startup
- âœ… Validate timezone sebelum membuat cron job
- âœ… Fallback ke UTC jika timezone invalid
- âœ… Stop existing job sebelum membuat job baru

### 8. **Data Validation**
- âœ… Validate semua input dari user (nama, host, username, password, port)
- âœ… Validate router data sebelum save (name, host, username, password required)
- âœ… Check duplicate router name sebelum add
- âœ… Validate time format (HH:MM) untuk schedule setting

### 9. **File Paths**
- âœ… SELALU gunakan `path.join()` untuk path construction
- âœ… Gunakan `__dirname` untuk relative paths dari file saat ini
- âœ… Backup directory: `config.backup.directory`
- âœ… Router data: `data/routers.json`
- âœ… Custom schedule: `data/customSchedule.json`

### 10. **Naming Conventions**
- âœ… Function names: camelCase (`sendBackup`, `performBackup`)
- âœ… Variable names: camelCase (`chatId`, `routerName`)
- âœ… File names: camelCase dengan extension (`.backup`, `.rsc`)
- âœ… Router names: sanitize dengan `safeName()` untuk file names

### 11. **Error Messages**
- âœ… Pesan error dalam Bahasa Indonesia
- âœ… SELALU sanitize error sebelum kirim ke user
- âœ… Jangan expose password/kredensial dalam error messages
- âœ… Gunakan emoji untuk status (âœ…, âŒ, â„¹ï¸, ğŸ“Š, dll)

### 12. **Code Organization**
- âœ… Pisahkan logic ke service files (`mikrotikService.js`, `routerStore.js`)
- âœ… Main bot logic di `index.js`
- âœ… Config loading di `config.js`
- âœ… Helper functions di top level atau di akhir file

## ğŸš« Yang TIDAK BOLEH Dilakukan

1. âŒ JANGAN commit file sensitif:
   - `.env`
   - `data/routers.json`
   - `backups/` directory
   - `*.log` files

2. âŒ JANGAN hardcode kredensial atau token di code
3. âŒ JANGAN expose password dalam error messages atau logs
4. âŒ JANGAN gunakan ES6 modules
5. âŒ JANGAN lupa close SSH connections atau file streams
6. âŒ JANGAN skip error handling untuk network operations
7. âŒ JANGAN buat race conditions pada file operations (gunakan queue)

## âœ… Best Practices

1. **Atomic Operations**: Gunakan temp file + rename untuk write operations
2. **Queue-based Locking**: Untuk mencegah race conditions pada concurrent writes
3. **Graceful Degradation**: Handle network errors tanpa crash bot
4. **Resource Cleanup**: SELALU cleanup resources (connections, streams) di `finally` blocks
5. **Input Validation**: Validate semua user input sebelum processing
6. **Error Sanitization**: SELALU sanitize errors sebelum kirim ke user
7. **Session Timeout**: Auto-cleanup sessions setelah 30 menit
8. **Timezone Validation**: Validate timezone sebelum membuat cron job

## ğŸ”„ Git Workflow

1. âœ… SETIAP perubahan HARUS langsung di-commit dengan message yang jelas
2. âœ… SETIAP commit HARUS langsung di-push ke remote
3. âœ… Commit message format: `feat: description` atau `fix: description`
4. âœ… Jangan commit file yang ada di `.gitignore`

## ğŸ“¦ Dependencies Management

- âœ… Jangan update dependencies tanpa alasan yang jelas
- âœ… Test setelah update dependencies
- âœ… Lock versions di `package-lock.json` (jangan commit jika tidak perlu)

## ğŸ§ª Testing Considerations

- âœ… Test SSH connection sebelum backup
- âœ… Test file operations (read/write)
- âœ… Test session management (timeout, cleanup)
- âœ… Test error handling (network errors, invalid input)

## ğŸŒ Bahasa & Lokalisasi

- âœ… Semua pesan bot dalam Bahasa Indonesia
- âœ… Format tanggal: `Intl.DateTimeFormat('id-ID')`
- âœ… Timezone default: `Asia/Jakarta`

## ğŸ” Security

- âœ… Jangan log password atau kredensial
- âœ… Sanitize semua error messages
- âœ… Validate chat ID whitelist
- âœ… Jangan expose internal paths atau struktur

## ğŸ“ Contoh Code Patterns

### Error Handling dengan Sanitization
```javascript
try {
  await performBackup(router);
} catch (err) {
  const sanitizedError = sanitizeError(err);
  await bot.sendMessage(chatId, `Error: ${sanitizedError}`);
}
```

### SSH Connection dengan Cleanup
```javascript
const conn = await connectSsh(router);
try {
  // operations
} finally {
  conn.end();
}
```

### Atomic File Write
```javascript
const tempPath = `${routersPath}.tmp`;
await fs.writeJSON(tempPath, data, { spaces: 2 });
await fs.rename(tempPath, routersPath);
```

### Session Management
```javascript
sessions.set(chatId, { action: 'add_router', step: 'name', data: {} });
setSessionTimeout(chatId);
// ... later
clearSession(chatId);
```

## ğŸ¯ Prioritas Saat Bekerja

1. **Security**: Jangan expose kredensial
2. **Reliability**: Handle errors dengan baik
3. **Resource Management**: Cleanup connections/streams
4. **User Experience**: Pesan error yang jelas dan helpful
5. **Code Quality**: Follow patterns yang sudah ada

